<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

<html>
    <div id="app">
        <head>
            <title>SMO Talkatoo Translator</title>
            <link rel="stylesheet" type="text/css" href="style.css">
        </head>
        <body>
            <div class="window" v-bind:style="{ backgroundImage: 'url(\'images/' + selectedKingdom + '.png\')' }">
              <div class="tabs">
                <div v-for="kingdom in kingdoms" class="tab" :class="{'selected': kingdom === selectedKingdom}" @click="selectKingdom(kingdom)">
                    {{ kingdom }}
                </div>
              </div>
            <div v-if="selectedKingdom" class="container">
                <div v-if="selectedKingdomHasMoons" class="card">
                    <ul class="list">
                        <template v-for="(possibleMoons, index) in mentionedMoons">
                            <li v-if="mentionedMoons[index][0].kingdom === selectedKingdom" class="list-item">
                                <template v-if="possibleMoons.length > 1">
                                    <template v-if="possibleMoons.some(moon => moon.correct)">
                                        <span @click="toggleMoonCollected(index)" :class="{'collected': isCollected(index)}">{{ moonToString(possibleMoons.find(moon => moon.correct)) }}</span>
                                        <span @click="undoCorrectOption(index)" class="material-symbols-outlined">undo</span>
                                    </template>
                                    <template v-else>
                                        <div>
                                            {{ possibleMoons.length }} possible options:
                                        </div>
                                        <ul>
                                            <li v-for="(moon, optionIndex) in possibleMoons" class="moon-option">
                                                 {{ moonToString(moon) }}
                                                <span @click="markCorrectOption(index, optionIndex)" class="material-symbols-outlined">check</span>
                                            </li>
                                        </ul>
                                    </template>
                                </template>
                                <div v-else>
                                    <span @click="toggleMoonCollected(index)" :class="{'collected': isCollected(index)}">{{ moonToString(possibleMoons[0]) }}</span>
                                </div>
                            </li>
                        </template>
                    </ul>
                </div>
            </div>
            </div>
        </body>
    </div>
</html>


<script type="text/javascript" src="/eel.js"></script>

<script>
    const { createApp } = Vue

    createApp({
        data() {
            return {
                kingdoms: ["Cascade", "Sand", "Lake", "Wooded", "Lost", "Metro", "Snow", "Seaside", "Luncheon", "Bowsers"],
                moonsByKingdom: [],
                mentionedMoons: [],
                collectedMoons: [],
                selectedKingdom: "Cascade"
            }
        },
        methods: {
            getMoonsByKingdom() {
                eel.get_moons_by_kingdom()().then(response => {
                    this.moonsByKingdom = response;
                });
            },
            updateMoons() {
                eel.get_mentioned_moons()().then(response => {
                    if (response.length > this.mentionedMoons.length) {
                        this.mentionedMoons = response;

                        const latestMoon = response[response.length - 1][0];
                        this.selectedKingdom = latestMoon.kingdom;

                        setTimeout(this.scrollToBottom, 10);
                    }
                });
            },
            scrollToBottom() {
                const card = document.querySelector('.card');
                card.scrollTop = card.scrollHeight;
            },
            moonToString(moon) {
                return `${moon.id} - ${moon.english} - ${moon.chinese_simplified}`;
            },
            selectKingdom(kingdom) {
                this.selectedKingdom = kingdom;
            },
            isCollected(index) {
                return this.collectedMoons.some(m => m.index === index && m.kingdom === this.selectedKingdom);
            },
            toggleMoonCollected(index) {
                if (this.isCollected(index)) {
                    this.collectedMoons = this.collectedMoons.filter(m => m.index !== index || m.kingdom !== this.selectedKingdom);
                } else {
                    this.collectedMoons.push({
                        kingdom: this.selectedKingdom,
                        index: index
                    });
                }
            },
            markCorrectOption(index, optionIndex) {
                this.mentionedMoons[index][optionIndex].correct = true;
            },
            undoCorrectOption(index) {
                this.collectedMoons = this.collectedMoons.filter(m => m.index !== index || m.kingdom !== this.selectedKingdom);
                this.mentionedMoons[index] = this.mentionedMoons[index].map(({correct, ...attrs}) => attrs);
            }
        },
        computed: {
            selectedKingdomHasMoons() {
                return this.mentionedMoons.some(possibleMoons => possibleMoons[0].kingdom === this.selectedKingdom);
            }
        },
        created() {
            this.getMoonsByKingdom();
            setInterval(this.updateMoons, 1000);
        },
    }).mount('#app')

</script>

<style>

    body {
        width: 100%;
        height: 100%;
        margin: 0;
        font-family: Roboto, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .window {
        height: 100%;
        width: 100%;
        display: flex;
        flex-direction: column;
        background-repeat: no-repeat; /* Do not repeat the image */
        background-size: cover; /* Resize the background image to cover the entire container */
        background-position: center;
    }

    .tabs {
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid rgba(0, 0, 0, 0.12); /* This is the default border color for UI elements in Material Design */
        background-color: #464454;
        color: #f5f5f5;
    }

    .tab {
        padding: 10px;
        flex-grow: 1;
        cursor: pointer;
        font-size: 14px; /* This is the default font size for body text in Material Design */
        font-weight: 500;
        background-color: #464454;
        text-align: center;
        color: #f5f5f5;
    }

    .selected {
        background-color: #343338;
    }

    .container {
        display: flex;
        justify-content: center;
        align-items: flex-start;
    }

    .card {
        margin: 100px 32px 0;
        width: 1000px;
        max-height: calc(100vh - 250px);
        border-radius: 6px; /* This will give the card rounded corners */
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2); /* This will give the card a shadow */
        background-color: #464454;
        overflow: auto;
        opacity: 0.9;
    }

    /* Hide scrollbar for Chrome, Safari and Opera */
    .card::-webkit-scrollbar {
        display: none;
    }

    /* Hide scrollbar for IE, Edge and Firefox */
    .card {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }

    .list {
        background-color: #464454;
        color: #f5f5f5;
        display: table;
        margin: auto;
        padding-top: 10px;
        padding-bottom: 5px;
    }

    .list-item {
        margin: auto;
        margin-bottom: 5px;
    }

    .collected {
        text-decoration: line-through;
    }

    .moon-option {
        margin-left: 12px;
    }

</style>

